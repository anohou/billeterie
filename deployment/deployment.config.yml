# =============================================================================
# üìù IMPORTANT: Project customization variables are in the
#    "PROJECT CUSTOMIZATION" section below (after infrastructure and project)
# =============================================================================

# =============================================================================
# üèóÔ∏è INFRASTRUCTURE & PROJECT CONFIGURATION
# =============================================================================

# Portable Laravel Deployment Configuration
# This single YAML file is the source of truth for all deployment configuration
# Environment-specific overrides are nested under 'environments' section

# Infrastructure configuration - customize these paths for your environment
infrastructure:
  # Base path for volume mounts (e.g., /srv/apps, /opt/apps, /data/apps)
  # Use {base_path} placeholder in volume paths below
  base_path: /srv/apps

  # Base path for external secrets files and configuration
  # Use {secrets_base_path} placeholder in secrets_file paths below
  secrets_base_path: /srv/apps/.config

  # Traefik reverse proxy configuration
  traefik:
    # Network name for Traefik connectivity
    network_name: traefik_swarm_network

project:
  name: billeterie
  display_name: "Billeterie - Vente de tickets en temps r√©el"

# =============================================================================
# üéØ PROJECT CUSTOMIZATION - Edit these values for your deployment
# =============================================================================
# These YAML anchors (&name) are referenced throughout the configuration.
# Update these values when porting to a new project or environment.
# =============================================================================

# Local environment variables
local_vars:
  domain: &local_domain "billeterie.localhost"
  url: &local_url "http://billeterie.localhost"

# Common variables (shared across environments)
common_vars:
  repository: &repo_url "ghcr.io/anohou/billeterie"
  image_name: &image_name "billeterie"
  volumes: &default_volumes
    storage_path: "{base_path}/anohou-apps/{env}/{project_name}/storage"
    public_uploads_path: "{base_path}/anohou-apps/{env}/{project_name}/public-uploads"
    logs_path: "{base_path}/anohou-apps/{env}/{project_name}/logs"
  secrets: &default_secrets
    - "{secrets_base_path}/{env}/laravel/common-values.{env}.new.env"
    - "{secrets_base_path}/{env}/laravel/{project_name}.env"

# Staging environment variables
staging_vars:
  app_name: &stg_app_name "Billeterie - Vente de tickets en temps r√©el (Staging)"
  domain: &stg_domain "billeterie.anohou.dev"
  # Database name (DB_DATABASE) must be set in project secrets file:
  # /srv/apps/.config/staging/laravel/billeterie.env
  session_domain: &stg_session_domain "billeterie.anohou.dev"
  origin: &stg_origin "https://billeterie.anohou.dev"
  url_path: &stg_url_path "/billeterie-stg-A9saHe0OPdhdEdJuZrap8dqKHxUT4gqJOscutnep"
  url: &stg_url "https://billeterie.anohou.dev/billeterie-stg-A9saHe0OPdhdEdJuZrap8dqKHxUT4gqJOscutnep"

# Production environment variables
production_vars:
  app_name: &prod_app_name "Billeterie - Vente de tickets en temps r√©el"
  domain: &prod_domain "billeterie.anohou.dev"
  # Database name (DB_DATABASE) must be set in project secrets file:
  # /srv/apps/.config/production/laravel/billeterie.env
  origin: &prod_origin "https://billeterie.anohou.dev"
  # Security: Explicit subdomain list (no wildcards)
  cors_origins: &prod_cors_origins "{{{PRODUCTION_CORS_ORIGINS}}}"
  sanctum_domains: &prod_sanctum_domains "{{{PRODUCTION_SANCTUM_DOMAINS}}}"
  session_domain: &prod_session_domain "billeterie.anohou.dev"
  url_path: &prod_url_path "/billeterie-prod-e9K78oqNOFizE8bJw2szYM61O34JTMY2SPiTkuR3"
  url: &prod_url "https://billeterie.anohou.dev/billeterie-prod-e9K78oqNOFizE8bJw2szYM61O34JTMY2SPiTkuR3"

# =============================================================================
# üê≥ DOCKER & RUNTIME CONFIGURATION
# =============================================================================

docker:
  service_name: app
  container_name_pattern: "dc_{project_name}_{env}"
  image_name_pattern: "{project_name}_{env}"
  compose_project_pattern: "{project_name}_{env}"

  registry:
    host: ghcr.io
    namespace: anohou
    image: *image_name

health:
  endpoint: "/api/health"
  timeout: 30
  max_attempts: 30

# Deployment behavior defaults (can be overridden per-environment)
deployment:
  git:
    pull_latest: false
    enable_rollback: true
    stash_changes: true

  image:
    use_remote: false
    allow_local_build: false
    pull_max_attempts: 4
    pull_retry_wait: 5

  database:
    enable_connection_test: true
    test_max_attempts: 5
    test_initial_wait: 5
    test_use_exponential_backoff: true

  diagnostics:
    startup_log_tail_lines: 50
    startup_log_scan_lines: 200

# Laravel application defaults (can be overridden per-environment)
# Only values actively used in .env generation are included
laravel:
  core:
    name: "Billeterie - Vente de tickets en temps r√©el"
    debug: false
    timezone: UTC
    locale: en
    fallback_locale: en
    faker_locale: en_US

  logging:
    channel: stack
    level: debug

  session:
    lifetime: 120
    encrypt: false

  cache:
    driver: redis
    store: redis

  queue:
    connection: database

  broadcast:
    connection: null

  cors:
    allowed_origins: "http://localhost:3000,http://localhost"

  sanctum:
    stateful_domains: "localhost,127.0.0.1"

# Environment-specific configuration overrides
# Values here override the defaults above for specific environments
environments:
  local:
    deployment:
      git:
        pull_latest: false
      image:
        use_remote: false
        allow_local_build: true
      database:
        enable_connection_test: true
        auto_migrate_on_deploy: true  # Auto-run migrations in non-production

    docker:
      url_domain: billeterie.localhost
      url_path: ""
      secrets_files: ['deployment/config/local-secrets.env']

    health:
      timeout: 60
      max_attempts: 15

    laravel:
      core:
        name: "Billeterie - Vente de tickets en temps r√©el Local"
        env: local
        debug: true
        url: http://billeterie.localhost
        asset_url: http://billeterie.localhost

      session:
        domain: .localhost
        secure_cookie: false
        same_site: lax

      logging:
        level: debug

      cors:
        allowed_origins: "http://localhost:3000,http://localhost,http://billeterie.localhost"

      sanctum:
        stateful_domains: "localhost,billeterie.localhost,127.0.0.1"

  staging:
    # Variables defined in PROJECT CUSTOMIZATION section above

    deployment:
      git:
        pull_latest: false
        enable_rollback: true
      image:
        use_remote: false
        allow_local_build: true
        repository: *repo_url
        tag: staging
      database:
        auto_migrate_on_deploy: true  # Auto-run migrations in staging

    docker:
      url_domain: *stg_domain
      url_path: *stg_url_path

      # Multi-secrets file support: common + app-specific
      secrets_files: *default_secrets

      registry:
        image: *image_name

      volumes: *default_volumes

    health:
      timeout: 30
      max_attempts: 30

    laravel:
      core:
        name: *stg_app_name
        env: staging
        debug: false
        url: *stg_url
        asset_url: *stg_url

      # Database configuration (DB_* variables) comes from secrets files

      session:
        secure_cookie: true
        same_site: none
        domain: *stg_session_domain

      cors:
        allowed_origins: *stg_origin

      sanctum:
        stateful_domains: *stg_domain

      logging:
        level: debug

      cache:
        driver: file
        store: file

  production:
    # Variables defined in PROJECT CUSTOMIZATION section above

    deployment:
      git:
        pull_latest: false
        enable_rollback: true
      image:
        use_remote: true
        allow_local_build: false
        repository: *repo_url
        tag: production
        tag_override: ""

    docker:
      url_domain: *prod_domain
      url_path: *prod_url_path

      # Multi-secrets file support: common + app-specific
      secrets_files: *default_secrets

      registry:
        image: *image_name

      volumes: *default_volumes

    health:
      timeout: 30
      max_attempts: 10

    health_check:
      enabled: false
      endpoint: /api/health
      max_attempts: 10
      timeout_seconds: 30

    laravel:
      core:
        name: *prod_app_name
        env: production
        debug: false
        url: *prod_url
        asset_url: *prod_url

      # Database configuration (DB_* variables) comes from secrets files

      session:
        secure_cookie: true
        same_site: none
        domain: *prod_session_domain

      cors:
        allowed_origins: *prod_cors_origins

      sanctum:
        stateful_domains: *prod_sanctum_domains

      logging:
        level: warning

      cache:
        driver: file
        store: file

# Feature Configuration - Enable/Disable Features
features:
  # === Validation Features ===
  input-validation:
    enabled: true
    valid_environments: [local, staging, production]
    valid_actions: [deploy, migrate, rollback, restart, stop]

  health-check:
    enabled: true

  secrets-completeness:
    enabled: true
    required_secrets:
      - APP_KEY
      - DB_PASSWORD

  secrets-validation:
    enabled: true
    required_vars: DB_HOST,DB_DATABASE,DB_USERNAME,DB_PASSWORD,APP_KEY

  dependency-checks:
    enabled: true
    docker:
      min_version: "20.10.0"
    docker_compose:
      min_version: "2.0.0"

  # === Security Features ===
  image-digest:
    enabled: false
    skip_for_local_builds: true

  secrets-rotation:
    enabled: true
    notification: true

  permission-checks:
    enabled: true
    mode: warning
    secrets_mode: 600
    scripts_mode: 755

  # === Reliability Features ===
  rollback:
    enabled: true
    auto_rollback: true
    backup_path: "/tmp/{project_name}-backups"
    retention_days: 7

  retry-logic:
    enabled: true
    max_attempts: 5
    initial_timeout: 1
    max_timeout: 32

  disk-space:
    enabled: true
    min_free_mb: 1000

  # === Monitoring Features ===
  audit-logging:
    enabled: true
    file: "/tmp/{project_name}-deployments.log"
    retention_days: 90
    max_size_mb: 100

  drift-detection:
    enabled: true

  # === Notification Features ===
  discord:
    enabled: false
    webhook_url_env: "DISCORD_WEBHOOK_URL"

  slack:
    enabled: false
    webhook_url_env: "SLACK_WEBHOOK_URL"

  telegram:
    enabled: false
    bot_token_env: "TELEGRAM_BOT_TOKEN"
    chat_id_env: "TELEGRAM_CHAT_ID"

  # === Advanced Features ===
  zero-downtime:
    enabled: false
    strategy: "blue-green"
    health_check_timeout: 60
