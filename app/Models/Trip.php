<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;
use Illuminate\Database\Eloquent\Concerns\HasUuids;

class Trip extends Model
{
    use HasUuids;
    
    public $incrementing = false;
    protected $keyType = 'string';

    protected $fillable = ['route_id','vehicle_id','departure_at','status','booking_type','sales_control'];

    protected $casts = [
        'departure_at' => 'datetime',
    ];

    protected $appends = ['total_seats', 'available_seats'];

    public function getTotalSeatsAttribute()
    {
        return $this->vehicle?->vehicleType?->seat_count ?? 0;
    }

    public function getAvailableSeatsAttribute()
    {
        $total = $this->total_seats;
        $occupied = $this->tickets()->where('status', '!=', 'cancelled')->count();
        return max(0, $total - $occupied);
    }

    /**
     * Vérifie si le voyage autorise les ventes depuis les stations intermédiaires
     */
    public function isSalesOpen(): bool
    {
        return $this->sales_control === 'open';
    }

    /**
     * Vérifie si le voyage est réservé à la station d'origine uniquement
     */
    public function isSalesClosed(): bool
    {
        return $this->sales_control === 'closed' || $this->sales_control === null;
    }

    /**
     * Vérifie si le voyage utilise le placement intelligent des sièges
     */
    public function isSeatAssignment(): bool
    {
        return $this->booking_type === 'seat_assignment';
    }

    /**
     * Vérifie si le voyage est en mode vrac (sans placement intelligent)
     */
    public function isBulk(): bool
    {
        return $this->booking_type === 'bulk';
    }

    /**
     * Vérifie si le voyage est en mode semi-intelligent (réutilisation des sièges)
     * Permet de vendre des tickets pour des trajets différents en réutilisant les sièges
     * qui se libèrent aux arrêts intermédiaires
     */
    public function isSemiIntelligent(): bool
    {
        return $this->booking_type === 'semi_intelligent';
    }

    protected static function booted(): void
    {
        static::creating(function (self $model): void {
            if (empty($model->id)) {
                $model->id = (string) Str::uuid();
            }
        });
    }

    public function route()
    {
        return $this->belongsTo(Route::class);
    }

    public function vehicle()
    {
        return $this->belongsTo(Vehicle::class);
    }

    public function tickets()
    {
        return $this->hasMany(Ticket::class);
    }

    public function tripSeatOccupancies()
    {
        return $this->hasMany(TripSeatOccupancy::class);
    }
}
