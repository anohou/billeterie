<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Inertia\Inertia;
use App\Models\Trip;
use App\Models\Route as BusRoute;

class SellerDashboardController extends Controller
{
    public function index()
    {
        $user = request()->user();
        
        if ($user->role === 'admin' || $user->role === 'supervisor') {
            $trips = Trip::with(['route', 'vehicle.vehicleType'])
                ->orderBy('departure_at','asc')
                ->limit(10)
                ->get();
            $routes = BusRoute::all();
        } else {
            // Unifier avec la logique de TicketingController: Basé sur les stations assignées
            $assignedStationIds = \App\Models\UserStationAssignment::where('user_id', $user->id)
                ->where('active', true)
                ->pluck('station_id')
                ->toArray();

            $routes = BusRoute::where(function($query) use ($assignedStationIds) {
                $query->whereIn('origin_station_id', $assignedStationIds)
                      ->orWhereHas('stops', function($q) use ($assignedStationIds) {
                          $q->whereIn('station_id', $assignedStationIds);
                      });
            })
            ->where('active', true)
            ->get();
            
            $routeIds = $routes->pluck('id');

            $trips = Trip::with(['route', 'vehicle.vehicleType'])
                ->whereIn('route_id', $routeIds)
                ->where('departure_at', '>=', now())
                ->orderBy('departure_at','asc')
                ->limit(10)
                ->get();
            
            $hasActiveAssignment = count($assignedStationIds) > 0;
            $assignedStation = $hasActiveAssignment 
                ? \App\Models\Station::find($assignedStationIds[0])?->name 
                : null;
        }
        $vehicles = \App\Models\Vehicle::with('vehicleType')->get();
        
        $todaySales = \App\Models\Ticket::where('seller_id', $user->id)
            ->whereDate('created_at', now()->today())
            ->where('status', '!=', 'cancelled')
            ->sum('price');

        return Inertia::render('Dashboards/Seller', [
            'trips' => $trips,
            'routes' => $routes,
            'vehicles' => $vehicles,
            'todaySales' => $todaySales,
            'hasActiveAssignment' => $hasActiveAssignment ?? true,
            'assignedStation' => $assignedStation ?? null,
        ]);
    }
}
